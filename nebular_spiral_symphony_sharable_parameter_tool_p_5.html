<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Nebular Spiral Symphony — Sharable Parameter Tool (p5.js)</title>

  <!-- Libraries -->
  <script defer src="https://cdn.jsdelivr.net/npm/p5@1.4.0/lib/p5.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/p5@1.4.0/lib/addons/p5.sound.min.js"></script>

  <style>
    :root {
      --bg: #0b0b12;
      --fg: #e6e6f0;
      --muted: #9aa0b1;
      --accent: #8b5cf6; /* purple */
      --accent-2: #22d3ee; /* cyan */
      --panel: #12121c;
      --panel-2: #161628;
      --chip: #1e1e33;
      --chip-text: #cbd5ff;
      --chip-border: #2b2b47;
    }
    * { box-sizing: border-box; }
    html, body {
      margin: 0; padding: 0; height: 100%;
      background: radial-gradient(1200px 900px at 70% 10%, #111126 0%, #0b0b12 60%, #06060b 100%);
      color: var(--fg);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, sans-serif;
    }

    /* Layout */
    .wrap {
      position: fixed; inset: 0; display: grid;
      grid-template-columns: minmax(280px, 360px) 1fr; gap: 0;
    }
    aside {
      background: linear-gradient(180deg, var(--panel) 0%, var(--panel-2) 100%);
      border-right: 1px solid #191933;
      padding: 18px 16px 16px;
      overflow: auto;
    }
    main { position: relative; overflow: hidden; }

    /* Header */
    .brand {
      display: flex; align-items: center; gap: 10px; margin-bottom: 14px;
    }
    .logo {
      width: 28px; height: 28px; border-radius: 8px;
      background: conic-gradient(from 0deg, var(--accent), var(--accent-2), var(--accent));
      filter: saturate(120%);
      box-shadow: 0 0 22px rgba(139, 92, 246, 0.35);
    }
    h1 {
      font-size: 16px; margin: 0; line-height: 1.25;
      font-weight: 700; letter-spacing: 0.2px;
    }
    .sub {
      font-size: 11px; color: var(--muted); margin: 3px 0 0 0;
    }

    /* Group panels */
    .group {
      background: #121226;
      border: 1px solid #1e1e38;
      border-radius: 14px;
      padding: 12px; margin: 10px 0 12px 0;
      box-shadow: 0 2px 18px rgba(0,0,0,0.25), inset 0 1px 0 rgba(255,255,255,0.02);
    }
    .group h2 {
      font-size: 12px; letter-spacing: 0.6px; text-transform: uppercase;
      color: #b9c0ff; margin: 0 0 8px 0;
    }

    /* Controls */
    .row { display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: center; margin: 8px 0; }
    .row label { font-size: 12px; color: #c9cbea; }
    .row input[type="range"] { width: 100%; }
    .row input[type="number"] {
      width: 84px; padding: 6px 8px;
      border-radius: 8px; border: 1px solid #2a2a45;
      background: #0e0e1d; color: var(--fg);
      font-size: 12px;
    }

    /* Buttons */
    .btns { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
    button, .btn {
      appearance: none; border: 1px solid #2b2b47;
      color: var(--fg); background: #191933;
      border-radius: 10px; padding: 8px 10px; font-size: 12px;
      cursor: pointer;
    }
    .btn.primary {
      border-color: #3b2db5;
      background: linear-gradient(180deg, #3b2db5, #6b46f9);
      color: white; box-shadow: 0 6px 18px rgba(139,92,246,0.35);
    }

    /* Pills */
    .pill {
      display: inline-flex; align-items: center; gap: 6px;
      background: var(--chip);
      color: var(--chip-text);
      border: 1px solid var(--chip-border);
      border-radius: 999px;
      padding: 4px 8px; font-size: 11px;
    }

    /* Canvas overlay readout */
    #overlay {
      position: absolute; bottom: 10px; left: 10px; right: 10px;
      display: flex; flex-wrap: wrap; gap: 8px;
      justify-content: flex-start;
      pointer-events: none;
      background: rgba(0,0,0,0.0);
      padding: 0;
    }

    /* Import/Export modal */
    dialog {
      border: 1px solid #2a2a45; border-radius: 14px; padding: 0; overflow: hidden;
      background: #0e0e1d; color: var(--fg); max-width: 640px; width: 90vw;
      box-shadow: 0 20px 60px rgba(0,0,0,0.45);
    }
    dialog::backdrop { background: rgba(0,0,0,0.45); }
    .dlg-hd { padding: 12px 14px; background: #151532; border-bottom: 1px solid #23234a; font-weight: 700; }
    .dlg-bd { padding: 12px 14px; }
    .dlg-ft { padding: 12px 14px; border-top: 1px solid #23234a; display: flex; gap: 8px; justify-content: flex-end; }
    textarea {
      width: 100%; height: 240px; border-radius: 10px; padding: 10px;
      border: 1px solid #2a2a45; background: #0b0b16; color: var(--fg);
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      font-size: 12px;
    }

    /* Small text */
    .hint { font-size: 11px; color: var(--muted); margin-top: 6px; }
    .kv { display: grid; grid-template-columns: 140px 1fr; gap: 8px; font-size: 12px; }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- SIDEBAR -->
    <aside>
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>FAFE EMPIRE® — AI Quick ToolKit</h1>
          <div class="sub">Nebular Spiral Symphony • p5.js + p5.sound</div>
        </div>
      </div>

      <div class="group">
        <h2>Particles</h2>
        <div class="row">
          <label for="count">Count</label>
          <input id="count" type="number" min="200" max="12000" step="100" />
        </div>
        <div class="row">
          <label for="sizeMin">Size Min</label>
          <input id="sizeMin" type="number" min="0.2" max="6" step="0.1" />
        </div>
        <div class="row">
          <label for="sizeMax">Size Max</label>
          <input id="sizeMax" type="number" min="0.2" max="8" step="0.1" />
        </div>
        <div class="row">
          <label for="maxSpeed">Max Speed</label>
          <input id="maxSpeed" type="number" min="0.2" max="12" step="0.1" />
        </div>
      </div>

      <div class="group">
        <h2>Spiral Field</h2>
        <div class="row">
          <label for="spiralTightness">Tightness</label>
          <input id="spiralTightness" type="number" min="0.001" max="0.08" step="0.001" />
        </div>
        <div class="row">
          <label for="swirlAmp">Swirl Amp</label>
          <input id="swirlAmp" type="number" min="-3" max="6" step="0.05" />
        </div>
        <div class="row">
          <label for="noiseAmp">Noise Amp</label>
          <input id="noiseAmp" type="number" min="0" max="2" step="0.01" />
        </div>
        <div class="row">
          <label for="zDrift">Z Drift</label>
          <input id="zDrift" type="number" min="-0.02" max="0.05" step="0.001" />
        </div>
        <div class="row">
          <label for="zSinAmp">Z Sine Amp</label>
          <input id="zSinAmp" type="number" min="0" max="0.05" step="0.001" />
        </div>
        <div class="row">
          <label for="zSinFreq">Z Sine Freq</label>
          <input id="zSinFreq" type="number" min="0" max="0.2" step="0.001" />
        </div>
      </div>

      <div class="group">
        <h2>Interactivity</h2>
        <div class="row">
          <label for="boostFrames">Boost Frames</label>
          <input id="boostFrames" type="number" min="10" max="600" step="5" />
        </div>
        <div class="btns">
          <button id="reset">Reset</button>
          <button id="copyLink" class="btn primary">Copy Sharable Link</button>
          <button id="export">Export JSON</button>
          <button id="import">Import JSON</button>
        </div>
        <div class="hint">Click / tap the canvas to enable audio (browser policy).</div>
      </div>

      <div class="group">
        <h2>Status</h2>
        <div class="kv">
          <div>Particles</div><div id="kvParticles">—</div>
          <div>Audio</div><div id="kvAudio">—</div>
        </div>
      </div>
    </aside>

    <!-- CANVAS AREA -->
    <main id="canvasHost">
      <div id="overlay"></div>
    </main>
  </div>

  <dialog id="dlg">
    <div class="dlg-hd">Import / Export Settings</div>
    <div class="dlg-bd">
      <textarea id="dlgText" spellcheck="false"></textarea>
      <div class="hint">Paste settings JSON to import, or copy out to save/share.</div>
    </div>
    <div class="dlg-ft">
      <button id="dlgCancel">Cancel</button>
      <button id="dlgApply" class="btn primary">Apply</button>
    </div>
  </dialog>

<script>
(() => {
  // ---------- Config ----------
  const cfg = {
    canvas: {
      pixelDensity: 2,
      background: [255, 8, 4, 100],
      blendCycle: [
        { fadeRect: { fill: [255, 8, 4, 18] } }
      ]
    },
    flow_field: {
      particles: {
        count: 4200,
        size: { min: 0.6, max: 2.4 },
        physics: { maxSpeed: 3.0 },
        motion: {
          spiralTightness: 0.015,
          swirlAmp: 0.85,
          noiseAmp: 0.22,
          zDrift: 0.004,
          zSinAmp: 0.008,
          zSinFreq: 0.03
        }
      }
    },
    interactivity: {
      swirlBoost: { durationFrames: 120, boost: 0.015 }
    },
    audio: {
      enabled: true,
      baseFreq: 110,
      wobbleFreq: 0.07
    }
  };

  // ---------- State ----------
  let p5instance = null;
  let particles = [];
  let center = { x: 0, y: 0 };
  let maxR = 0;
  let zOff = 0;
  let boostUntil = 0;

  // ---------- Utils ----------
  function clamp(v, lo, hi){ return Math.max(lo, Math.min(hi, v)); }

  function applyCfgToUI(){
    const p = cfg.flow_field.particles;
    document.getElementById('count').value = p.count;
    document.getElementById('sizeMin').value = p.size.min;
    document.getElementById('sizeMax').value = p.size.max;
    document.getElementById('maxSpeed').value = p.physics.maxSpeed;

    const m = p.motion;
    document.getElementById('spiralTightness').value = m.spiralTightness;
    document.getElementById('swirlAmp').value = m.swirlAmp;
    document.getElementById('noiseAmp').value = m.noiseAmp;
    document.getElementById('zDrift').value = m.zDrift;
    document.getElementById('zSinAmp').value = m.zSinAmp;
    document.getElementById('zSinFreq').value = m.zSinFreq;
  }

  function readUIToCfg(){
    const p = cfg.flow_field.particles;
    p.count = +document.getElementById('count').value;
    p.size.min = +document.getElementById('sizeMin').value;
    p.size.max = +document.getElementById('sizeMax').value;
    p.physics.maxSpeed = +document.getElementById('maxSpeed').value;

    const m = p.motion;
    m.spiralTightness = +document.getElementById('spiralTightness').value;
    m.swirlAmp = +document.getElementById('swirlAmp').value;
    m.noiseAmp = +document.getElementById('noiseAmp').value;
    m.zDrift = +document.getElementById('zDrift').value;
    m.zSinAmp = +document.getElementById('zSinAmp').value;
    m.zSinFreq = +document.getElementById('zSinFreq').value;
  }

  function toSharableQuery(cfgObj){
    const json = JSON.stringify(cfgObj);
    const enc = encodeURIComponent(btoa(unescape(encodeURIComponent(json))));
    return '?cfg=' + enc;
  }
  function fromSharableQuery(){
    const q = new URLSearchParams(location.search).get('cfg');
    if(!q) return null;
    try{
      const json = decodeURIComponent(escape(atob(decodeURIComponent(q))));
      return JSON.parse(json);
    } catch(e){ return null; }
  }

  function randRange(a,b){ return a + Math.random()*(b-a); }

  // ---------- p5 Sketch ----------
  const sketch = (p) => {
    p.setup = function setup(){
      const host = document.getElementById('canvasHost');
      const cnv = p.createCanvas(host.clientWidth, host.clientHeight);
      cnv.parent(host);
      p.pixelDensity(cfg.canvas.pixelDensity);
      p.colorMode(p.HSB, 360,100,100,100);
      center.x = p.width/2; center.y = p.height/2;
      maxR = Math.min(p.width, p.height) * 0.5;
      p.background(cfg.canvas.background[0], cfg.canvas.background[1], cfg.canvas.background[2], cfg.canvas.background[3]);
      initParticles();
      applyCfgToUI();
      // load config from URL if present
      const incoming = fromSharableQuery();
      if(incoming){ Object.assign(cfg, incoming); applyCfgToUI(); resetParticlesKeepingCount(); }
      updateStatus();
    };

    p.windowResized = function(){
      const host = document.getElementById('canvasHost');
      p.resizeCanvas(host.clientWidth, host.clientHeight, true);
      center.x = p.width/2; center.y = p.height/2;
      maxR = Math.min(p.width, p.height) * 0.5;
      p.background(cfg.canvas.background[0], cfg.canvas.background[1], cfg.canvas.background[2], cfg.canvas.background[3]);
    };

    function initParticles(){
      particles = [];
      for(let i=0; i<cfg.flow_field.particles.count; i++){
        particles.push(makeParticle());
      }
    }
    function resetParticlesKeepingCount(){
      const n = clamp(cfg.flow_field.particles.count, 10, 50000);
      if (n > particles.length){
        const add = n - particles.length;
        for(let i=0;i<add;i++) particles.push(makeParticle());
      } else if (n < particles.length){
        particles.length = n;
      }
    }

    function makeParticle(){
      const r = Math.random() * maxR;
      const t = Math.random() * Math.PI * 2;
      return {
        x: center.x + Math.cos(t)*r,
        y: center.y + Math.sin(t)*r,
        vx: 0, vy: 0,
        size: randRange(cfg.flow_field.particles.size.min, cfg.flow_field.particles.size.max),
        hue: (t*180/Math.PI + r*0.06) % 360
      };
    }

    function repaintFade(){
      p.blendMode(p.BLEND);
      const fr = cfg.canvas.blendCycle[0].fadeRect.fill;
      p.noStroke(); p.fill(fr[0],fr[1],fr[2],fr[3]);
      p.rect(0,0,p.width,p.height);
    }

    function spiralForce(x,y){
      const m = cfg.flow_field.particles.motion;
      const dx = x - center.x, dy = y - center.y;
      const r = Math.hypot(dx,dy) / (maxR+1e-6);
      let ang = Math.atan2(dy,dx) + m.spiralTightness*(1+r*2);
      const nx = Math.cos(ang), ny = Math.sin(ang);

      // swirl boost on click
      const boost = (p.frameCount < boostUntil) ? m.swirlAmp + cfg.interactivity.swirlBoost.boost : m.swirlAmp;

      const n = p.noise(x*0.002, y*0.002, zOff);
      const jitter = (n - 0.5) * 2 * m.noiseAmp;
      return {
        fx: nx*boost + jitter,
        fy: ny*boost + jitter
      };
    }

    p.colorFor = function(i){
      const base = (i*0.35 + p.frameCount*0.4) % 360;
      return [ (base+200)%360, 70, 100, 70 ];
    };

    p.draw = function(){
      const m = cfg.flow_field.particles.motion;
      zOff += (m.zDrift + Math.sin(p.frameCount * m.zSinFreq) * m.zSinAmp);
      repaintFade();
      p.blendMode(p.ADD);
      p.noFill();
      for(let i=0;i<particles.length;i++){
        const pt = particles[i];
        const {fx,fy} = spiralForce(pt.x, pt.y);
        pt.vx = (pt.vx + fx);
        pt.vy = (pt.vy + fy);
        const spd = Math.hypot(pt.vx, pt.vy);
        const maxS = cfg.flow_field.particles.physics.maxSpeed;
        if(spd > maxS){ pt.vx *= maxS/spd; pt.vy *= maxS/spd; }
        const nx = pt.x + pt.vx;
        const ny = pt.y + pt.vy;
        // FIXED: spread operator typo → method call on p
        p.stroke(p.colorFor(i));
        p.strokeWeight(pt.size);
        p.line(pt.x, pt.y, nx, ny);
        pt.x = nx; pt.y = ny;
        const dx = pt.x - center.x, dy = pt.y - center.y;
        const rr = Math.sqrt(dx*dx + dy*dy);
        if(rr > maxR*1.2){ resetParticle(pt); }
      }
      updateStatus();
    };

    function resetParticle(pt){
      const r = Math.random() * (maxR*0.1);
      const t = Math.random() * Math.PI * 2;
      pt.x = center.x + Math.cos(t)*r;
      pt.y = center.y + Math.sin(t)*r;
      pt.vx = 0; pt.vy = 0;
    }

    p.mousePressed = p.touchStarted = function(){
      try { const ctx = getAudioContext(); if (ctx.state !== 'running') ctx.resume(); } catch(e){}
      if(cfg.audio.enabled) buildAudio();
      boostUntil = p.frameCount + cfg.interactivity.swirlBoost.durationFrames;
    };

    // ---------- Audio ----------
    let oscA, oscB, noise, filt, env;
    function buildAudio(){
      try {
        if(oscA) return; // build once
        oscA = new p5.Oscillator('sine'); oscA.freq(cfg.audio.baseFreq); oscA.amp(0.0); oscA.start();
        oscB = new p5.Oscillator('sawtooth'); oscB.freq(cfg.audio.baseFreq*2); oscB.amp(0.0); oscB.start();
        noise = new p5.Noise('pink'); noise.amp(0.0); noise.start();
        filt = new p5.HighPass(); noise.disconnect(); noise.connect(filt);
        env = new p5.Envelope(); env.setADSR(0.5, 1.8, 0.2, 1.2);

        // gentle wobble
        setInterval(() => {
          const t = Date.now()/1000;
          const wob = 1 + Math.sin(t*cfg.audio.wobbleFreq)*0.1;
          oscA.freq(cfg.audio.baseFreq * wob);
          oscB.freq(cfg.audio.baseFreq*2 * wob);
        }, 60);
      } catch(e) {}
    }
  };

  // ---------- Boot ----------
  function mount(){
    if(p5instance){ try{ p5instance.remove(); }catch(e){} }
    p5instance = new p5(sketch, document.body);
  }

  // UI wires
  function wire(){
    document.getElementById('reset').addEventListener('click', () => {
      readUIToCfg(); mount();
    });
    document.getElementById('copyLink').addEventListener('click', async () => {
      readUIToCfg();
      const url = location.origin + location.pathname + toSharableQuery(cfg);
      try { await navigator.clipboard.writeText(url); } catch(e){}
      flashOverlay(`Link copied`);
    });
    document.getElementById('export').addEventListener('click', () => {
      readUIToCfg();
      openDialog(JSON.stringify(cfg, null, 2), (txt) => {
        try { const obj = JSON.parse(txt); Object.assign(cfg, obj); mount(); } catch(e){}
      });
    });
    document.getElementById('import').addEventListener('click', () => {
      openDialog('', (txt) => {
        try { const obj = JSON.parse(txt); Object.assign(cfg, obj); mount(); } catch(e){}
      });
    });
    document.getElementById('dlgCancel').addEventListener('click', () => document.getElementById('dlg').close());
    document.getElementById('dlgApply').addEventListener('click', () => {
      const txt = document.getElementById('dlgText').value;
      try { const obj = JSON.parse(txt); Object.assign(cfg, obj); mount(); } catch(e){}
      document.getElementById('dlg').close();
    });

    // Sidebar inputs live-apply (optional)
    ['count','sizeMin','sizeMax','maxSpeed','spiralTightness','swirlAmp','noiseAmp','zDrift','zSinAmp','zSinFreq'].forEach(id => {
      document.getElementById(id).addEventListener('change', () => { readUIToCfg(); });
    });
  }

  function openDialog(text, onApply){
    const dlg = document.getElementById('dlg');
    const txt = document.getElementById('dlgText');
    txt.value = text || '';
    dlg.showModal();
    // store handler for Apply button
    dlg._apply = onApply;
    document.getElementById('dlgApply').onclick = () => {
      if(typeof dlg._apply === 'function'){ dlg._apply(txt.value); }
      dlg.close();
    };
  }

  function flashOverlay(msg){
    const ov = document.getElementById('overlay');
    const el = document.createElement('span');
    el.className = 'pill';
    el.textContent = msg;
    ov.appendChild(el);
    setTimeout(() => { ov.removeChild(el); }, 1200);
  }

  function updateStatus(){
    const kvp = document.getElementById('kvParticles');
    if(kvp) kvp.textContent = `${cfg.flow_field.particles.count}`;
    const kva = document.getElementById('kvAudio');
    if(kva) kva.textContent = `${cfg.audio.enabled? 'on' : 'off'}`;
  }

  window.addEventListener('DOMContentLoaded', () => { wire(); mount(); });
})();
</script>
</body>
</html>
